FROM python:latest

# Build arg $settings = (stage, develop, production, local, etc)
ARG settings

# Django App name
ARG $app

# Env vars
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1
ENV DJANGO_SETTINGS_MODULE="$App.settings.$settings"

RUN mkdir -p /app

# Set workdir
WORKDIR /app

# Add files
ADD . .

# Upgrade PIP3
RUN pip3 install --upgrade pip

# Install dependencies
RUN pip3 install -r requirements.txt

# Install web server
RUN pip3 install gunicorn

# Migrate to DB
RUN python manage.py migrate

# Collect static files
RUN python manage.py collectstatic --no-input

# Deploy gunicorn sever
CMD ["gunicorn", "--chdir", "/app", "--bind", ":8000", "$app.wsgi:application", "--workers", "3"]
